<style>
  .itemdetail.vcomp {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    font-size: 12px;
    overflow-y: auto;
    -ms-overflow-style: none;
    scrollbar-width: none;
    background: none;
  }

  .itemdetail.vcomp::-webkit-scrollbar {
    display: none;
  }

  .itemdetail.vcomp > .main {
    position: relative;
    width: 100%;
    color: #333333;
  }

  .itemdetail.vcomp > .main > .pixes {
    position: relative;
    width: 100%;
    padding-top: 100%;
  }

  .itemdetail.vcomp > .main > .pixes > .swiper-container {
    position: absolute;
    top: 1px;
    left: 1px;
    right: 1px;
    bottom: 1px;
    z-index: 0;
  }

  .itemdetail.vcomp > .main > .pixes > .swiper-container > .swiper-wrapper {
    z-index: 0;
  }

  .itemdetail.vcomp > .main > .pixes > .swiper-container > .swiper-wrapper > .swiper-slide {
    position: relative;
    width: 100%;
    height: 100%;
    background: white;
    display: flex;
    align-items: flex-end;
    justify-content: center;
  }

  .itemdetail.vcomp > .main > .pixes > .swiper-container > .swiper-wrapper > .swiper-slide > img {
    width: calc(100% - 32px);
    height: calc(100% - 32px);
    border-radius: 8px;
    object-fit: cover;
    opacity: 0;
    transition: all 0.5s;
    filter: brightness(95%);
  }

  .itemdetail.vcomp > .main > .pixes > .swiper-container > .swiper-wrapper > .swiper-slide > img.loaded {
    opacity: 1;
  }

  .itemdetail.vcomp > .main > .pixes > .swiper-container > .swiper-pagination > .swiper-pagination-bullet {
    background: rgba(255,255,255,0.4);
    opacity: 0;
  }

  .itemdetail.vcomp > .main > .pixes.paginated > .swiper-container > .swiper-pagination > .swiper-pagination-bullet {
    opacity: 1;
  }

  .itemdetail.vcomp > .main > .pixes > .swiper-container > .swiper-pagination > .swiper-pagination-bullet.swiper-pagination-bullet-active {
    /* background: rgba(0,0,0,0.7); */
    background: white;
  }

  .itemdetail.vcomp > .main > .txt {
    width: 100%;
    padding: 10px 16px;
    box-sizing: border-box;
    position: relative;
    transition: all 0.5s;
  }

  /* .itemdetail.vcomp > .main > .txt.period {
    font-size: 14px;
    padding-top: 10px;
    padding-bottom: 0;
  } */

  .itemdetail.vcomp > .main > .txt.name {
    font-size: 16px;
    padding-top: 16px;
  }

  .itemdetail.vcomp > .main > .txt.price {
    font-size: 18px;
    font-weight: bold;
    padding-top: 0;
  }

  .itemdetail.vcomp > .main > .txt.period {
    font-size: 18px;
    font-weight: bold;
    padding-top: 0;
  }

  .itemdetail.vcomp > .main > .txt.cum {
    text-align: right;
    padding-top: 0;
    color: #999999;
    font-size: 12px;
  }

  .itemdetail.vcomp > .main > .txt.desc {
    font-size: 11px;
    color: var(--color-gray);
    line-height: 15px;
    opacity: 0;
    white-space: pre-line;
  }

  .itemdetail.vcomp > .main > .txt.noti {
    font-size: 11px;
    color: var(--color-gray);
    line-height: 15px;
    opacity: 0;
  }

  .itemdetail.vcomp > .main.loaded > .txt.desc,
  .itemdetail.vcomp > .main.loaded > .txt.noti {
    opacity: 1;
  }

  .itemdetail.vcomp > .main > .txt > .action {
    position: absolute;
    bottom: 10px;
    right: 16px;
    height: 36px;
    width: 72px;
    background: var(--color-point);
    color: white;
    border-radius: 15px;
    font-size: 12px;
    font-weight: normal;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    opacity: 0.2;
    pointer-events: none;
    cursor: pointer;
  }

  .itemdetail.vcomp > .main > .txt > .action.active {
    opacity: 1;
    pointer-events: auto;
  }

  .itemdetail.vcomp > .main > .txt > .action.raffled {
    background: var(--color-dark);
    pointer-events: none;
  }

 .itemdetail.vcomp > .spinner {
   position: absolute;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   display: flex;
   align-items: center;
   justify-content: center;
   font-size: 30px;
   color: var(--color-dark);
 }
</style>

<script type='text/x-template' id='itemdetail-template'>
  <div class='itemdetail vcomp'>
    <div class='main' :class='{ loaded:ready }'>

      <div class='pixes' :class='{ paginated:paginated }'>
        <div class='swiper-container' ref='swiper'>
          <div class='swiper-wrapper'>
            <div class="swiper-slide" v-for='i in 5' v-if='pix(i-1)'>
              <img :src='pix(i-1)' @load='pix_loaded(i, $event)'>
            </div>
          </div>

          <div class="swiper-pagination"></div>
        </div>
      </div>

      <!-- <div class='txt period'>[[ days_to_due ]]</div> -->

      <div class='txt name'>[[ name ]]</div>

      <div class='txt price' v-if='is_shoptem || is_coffeecoupon'>
        [[ price_p ]]
        <div class='action buy' :class='{ active: buyable }' @click='buy'>
          구매하기
        </div>
      </div>

      <div class='txt period' v-if='is_raffle'>
        [[ days_to_due ]]
        <!-- [[ raffle_collected_p ]] -->
        <div class='action apply' :class='{ active: raffleable, raffled:raffled }' @click='apply_raffle'>
          <span>[[ action_raffle_text ]]</span>
          <span>[[ deduction_p ]]</span>
        </div>
      </div>

      <div class='txt cum'>[[ amount_raffled_text ]]</div>

      <div class='txt desc'>[[ desc ]]</div>

      <div class='txt noti' v-if='is_raffle'>
        <span>응모 기간 종료 후 3일 이내에 당첨자 추첨 및 발표가 진행 됩니다. 고객 실수로 인한 주소 오류 또는 연락처 미기재 등으로 인한 오발송 되는 경품은 재발송이 불가합니다.</span>
      </div>
    </div>

    <div class='spinner' v-if='!ready'>
      <i class="fa fa-spinner fa-spin"></i>
    </div>
  </div>
</script>


<script>
  Vue.component('itemdetail', {
    template: '#itemdetail-template',
    delimiters: ['[[', ']]'],
    props: [ 'obj', 'session' ],
    data: function() {
      return {
        swiper: undefined,
        swiper_options: {
          // direction: 'vertical',
          simulateTouch: true,
          observer: true,
          observeParents: true,
          slidesPerView: 'auto',
          // loop: true, 이걸쓰면 슬라이드가 클릭이 안되는듯
          mousewheel: {
            releaseOnEdges: true,
          },
          pagination: {
            el: '.swiper-pagination',
          }
        }
      }
    },

    mounted: function() {
      this.swiper = new Swiper(this.$refs.swiper, this.swiper_options);
    },

    watch: {
      n_pix: function(_new, _old) {}
    },

    methods: {
      pix_loaded: function(idx, event) {
        event.target.classList.add('loaded');
      },

      pix: function(idx) {
        if (this.item) {
          return this.item['pix_' + idx]
        }
      },

      buy: function() {
        if (this.buyable) {
          let msg;

          if (this.session.user.auth.mobile_verified) {
            msg = `구매하시겠습니까? \n${this.price}P가 차감되며, 취소는 불가합니다`;
            const resp = confirm(msg);

            if (resp) {
              this.myboo.wallet.send(this.type, this.price, this.obj.id);

              // const iraffle = _.find(this.myboo.raffles.list, ['id', receiver_id]);
              // if (!iraffle) {
              //   this.myboo.raffles.list.push(this.raffle);
              // }
            }

          } else {

          }
        }
      },

      apply_raffle: function() {
        if (this.raffleable) {
          const receiver_id = this.raffle.id;
          const amount = this.deduction;
          const msg = `래플에 참여하시겠습니까? \n참여시 ${amount}P가 차감되며, 취소는 불가합니다`;
          const resp = confirm(msg);

          if (resp && receiver_id && amount) {
            this.raffle.wallet.collected += amount;
            this.raffle.wallet.amount_raffled += amount;
            this.raffle.wallet.raffled = true;
            this.myboo.wallet.send('raffle', amount, receiver_id);
            // this.myboo.raffles.list.push(this.obj);

            const iraffle = _.find(this.myboo.raffles.list, ['id', receiver_id]);
            if (!iraffle) {
              this.myboo.raffles.list.push(this.raffle);
            }
          }
        }
      }
    },

    computed: {
      n_pix: function() {
        if (this.swiper) {
          return this.swiper.slides.length
        }
      },

      paginated: function() {
        return this.n_pix > 1
      },

      item: function() {
        if (this.obj && this.obj.item) {
          return this.obj.item.load()
        }
      },

      type: function() {
        if (this.obj) {
          return this.obj.constructor.name.toLowerCase()
        }
      },

      is_raffle: function() {
        return this.type == 'raffle'
      },

      is_shoptem: function() {
        return this.type == 'shoptem'
        // return (this.type == 'shoptem') || (this.type=='coffeecoupon')
      },

      is_coffeecoupon: function() {
        return this.type=='coffeecoupon'
      },

      ready: function() {
        if (this.item) {
          return this.item.loaded
        }
      },

      name: function() {
        if (this.item) {
          return this.item.name
        }
      },

      price: function() {
        if (this.item) {
          return this.item.price
        }
      },

      price_p: function() {
        if (this.price) {
          return this.price.toLocaleString() + 'P'
        }
      },

      deduction: function() {
        if (this.obj) {
          if (this.obj.deduction) {
            return this.obj.deduction
          }
        }
      },

      deduction_p: function() {
        if (this.deduction) {
          return '-' + this.deduction.toLocaleString() + 'P'
        }
      },

      days_to_due: function() {
        if (this.obj && this.obj.due) {
          return '마감 ' + Math.ceil( (new Date(this.obj.due) - new Date()) / (1000 * 24 * 60 * 60) ) + '일전'

        } else {
          return ''
        }
      },

      desc: function() {
        if (this.item) {
          return this.item.desc
        }
      },

      raffle: function() {
        if (this.is_raffle) {
          return this.obj
        }
      },

      raffle_wallet: function() {
        if (this.raffle) {
          return this.raffle.wallet
        }
      },

      raffled: function() {
        if (this.raffle_wallet) {
          return this.raffle_wallet.raffled
        }
      },

      amount_raffled: function() {
        if (this.raffle_wallet) {
          return this.raffle_wallet.amount_raffled
        }
      },

      amount_raffled_text: function() {
        if (this.amount_raffled) {
          return '내 누적 참여 ' + this.amount_raffled + 'P'
        }
      },

      myboo: function() {
        if (this.session.user.has_auth) {
          return this.session.user.boo
        }
      },

      mywallet: function() {
        if (this.myboo) {
          return this.myboo.wallet
        }
      },

      budget: function() {
        if (this.mywallet) {
          return this.mywallet.amount
        }
      },

      raffleable: function() {
        return this.budget >= this.deduction
      },

      buyable: function() {
        return this.budget >= this.price
      },

      action_raffle_text: function() {
        if (this.raffled) {
          return '응모완료'

        } else {
          return '응모하기'
        }
      },

      raffle_collected: function() {
        if (this.raffle_wallet) {
          return this.raffle_wallet.collected
        }
      },

      raffle_collected_p: function() {
        if (this.raffle_collected != undefined) {
          return this.raffle_collected.toLocaleString() + 'P'
        }
      },
    }
  });
</script>
