<style>
  .profiler.vcomp .page-body {
    background: #f8f8f8;
  }

  .profiler.vcomp .page-body > .profiler-body {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* background: white; */
    /* overflow-y: auto;
    -ms-overflow-style: none;
    scrollbar-width: none; */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles {
    background: none;
    /* margin-top: var(--w-24); */
    /* margin-bottom: var(--w-20); */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    width: 100%;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile {
    width: var(--w-30);
    height: var(--w-30);
    background: none;
    transition: all 0.5s;
    position: relative;
    box-sizing: border-box;
    cursor: pointer;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile > * {
    pointer-events: none;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile.new {
    background: var(--color-dark);
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile > img.profilepix {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 50%;
    filter: brightness(95%);
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile > .profilepix-editor {
    position: absolute;
    width: 25%;
    height: 25%;
    pointer-events: none;
    bottom: 0;
    right: 0;
    background: white;
    border-radius: 100px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile > .profilepix-editor > img.icon {
    width: 60%;
    height: 60%;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick {
    /* font-size: 18px; */
    margin-top: 20px;
    position: relative;
    cursor: pointer;
    width: 60%;
    /* text-align: center; */
    height: 35px;
    border-radius: 100px;
    overflow: hidden;
  }

  /* .profiler.vcomp .page-body > .profiler-body > .profiles > .nick.warning {
    outline: 1px solid var(--color-point);
  } */

  .profiler.vcomp .page-body > .profiler-body > .profiles > .text {
    margin-top: 15px;
    position: relative;
    cursor: pointer;
    height: 80px;
    width: 60%;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > input {
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    width: 100%;
    border: none;
    height: 100%;
    box-sizing: border-box;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > textarea {
    font-size: 13px;
    width: 100%;
    border: none;
    height: 100%;
    resize: none;
    border-radius: 17.5px;
    background: white;
    padding: 10px;
    box-sizing: border-box;
    text-align: center;
    line-height: 20px;
    overflow: hidden;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > input:focus,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > textarea:focus {
    outline: none;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > textarea::placeholder {
    font-size: 13px;
    font-weight: normal;
    color: #999;
    white-space: pre-line;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > input::placeholder {
    font-size: 13px;
    font-weight: normal;
    color: var(--color-point);
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > .edit,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > .edit {
    position: absolute;
    top: 10px;
    right: 15px;
    /* transform: translateY(-50%); */
    pointer-events: none;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > span > img,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > span > img {
    width: 14px;
    height: auto;
    margin-left: 5px;
    /* pointer-events: none; */
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > span.tmp,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > span.tmp {
    color: lightgray;
  }

  .profiler.vcomp .page-body > .profiler-body > .actions {
    margin-top: 15px;
    position: relative;
    width: 100%;
  }

  .profiler.vcomp .page-body > .profiler-body > .actions > .action {
    position: relative;
    width: 60%;
    height: 35px;
    border-radius: 100px;
    background: var(--color-dark);
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    line-height: 35px;
    color: white;
    font-size: 13px;
    cursor: pointer;
    pointer-events: none;
    opacity: 0.2;
  }

  .profiler.vcomp .page-body > .profiler-body > .actions > .action.active {
    pointer-events: auto;
    opacity: 1;
  }
</style>


<script type='text/x-template' id='profiler-template'>
  <page
    class='profiler vcomp'
    :order='session.page.profiler.order'
    :open='session.page.profiler.open'
    :from='session.page.profiler.from'
    :hide_menu='true'
    :trans_headerbar='true'
    @close='session.close_page()'>

    <template #headerbar-menu>
    </template>

    <template #headerbar-body-trans>
    </template>

    <template #headerbar-body-default>
    </template>


    <template #page-body>
      <div class='profiler-body' v-if='boo'>

        <div class='profiles' ref='profiles'>
          <div class='profile' @click='load_pixeditor'>
            <input type="file" name="image" accept="image/*" style='display:none' @change='imagize' ref='pixinput'>
            <img class='profilepix' :src='profilepix_tmp' v-if='profilepix_tmp'>

            <div class='profilepix-editor'>
              <img class='icon' src='/static/materials/icons/edit.png'>
            </div>
          </div>

          <div class='nick' :class='{ warning: nick_tmp=="" }'>
            <input v-model.trim='nick_tmp' placeholder='닉네임(필수)' spellcheck='false'>
            <span class='edit'><img src='/static/materials/icons/edit.png'></span>
          </div>

          <div class='text'>
            <textarea rows='3' v-model.trim='text_tmp' placeholder='계정설명(선택사항)' spellcheck='false' @keydown='limitrows($event)'></textarea>
            <span class='edit'><img src='/static/materials/icons/edit.png'></span>
          </div>
        </div>


        <div class='actions'>
          <div class='action done' :class='{ active: savable }' @click='save'>저장하기</div>
        </div>
      </div>
    </template>
  </page>
</script>


<script>
  Vue.component('profiler', {
    template: '#profiler-template',
    delimiters: ['[[', ']]'],
    props: ['session'],
    data: function() {
      return {
        nick_tmp: '',
        text_tmp: '',
        profilepix_tmp: '',
        profilepix_blob: undefined
      }
    },

    watch: {
      'session.page.profiler.open': function(_new, _old) {
        if (_new && this.boo) {
          this.nick_tmp = this.nick;
          this.text_tmp = this.text;
          this.profilepix_tmp = this.profilepix;
          this.profilepix_blob = undefined;
        }

        if (_new) {
          this.session.fix_window_width();

        } else {
          this.session.release_window_width();
        }
      }
    },

    methods: {
      save: function() {
        if (!this.savable) {
          return
        }

        const backup = {};
        const formdata = new FormData();
        formdata.append('csrfmiddlewaretoken', '{{csrf_token}}');

        if (this.nick != this.nick_tmp) {
          backup.nick = this.nick;
          this.boo.nick = this.nick_tmp;
          formdata.append('boo_nick', this.nick_tmp);
        }

        if (this.text != this.text_tmp) {
          backup.text = this.text;
          this.boo.text = this.text_tmp;
          formdata.append('boo_text', this.text_tmp);
        }

        if (this.profilepix !=  this.profilepix_tmp) {
          backup.profilepix = this.profilepix;
          this.boo.profile.pix = this.profilepix_tmp;
          const pixname = new Date().getTime() + '__profilepix.png';
          formdata.append('profilepix', this.profilepix_blob, pixname);
        }

        this.boo_update(formdata, backup);
      },


      boo_update: function(formdata, backup) {
        fetch('/boo/save/', { method: 'POST', body: formdata })
          .then(res => res.json())
          .then(js => {
            console.log(js);

            if (js.success) {
              // alert('오 성공');

            } else {
              alert('프로필 정보저장에 실패하였습니다. 잠시 후에 다시 시도해주세요.');
              if (backup.nick) this.boo.nick = backup.nick;
              if (backup.text) this.boo.text = backup.text;
              if (backup.profilepix) this.boo.profile.pix = backup.profilepix;
            }
          });

        this.session.close_page();
      },

      load_pixeditor: function() {
        if (this.$refs) {
          this.$refs.pixinput.click();
        }
      },

      imagize: function(event) {
        const input = event.target;
        const self = this;

        if (input.files && input.files[0]) {
          let reader = new FileReader();
          reader.onload = function(e) {
            self.session.open_pixeditor(e.target.result, 'profile', self);
          };

          reader.readAsDataURL(input.files[0]);
        }
      },

      set: function(blob) {
        this.profilepix_tmp = URL.createObjectURL(blob);
        this.profilepix_blob = blob;
      },

      limitrows: function(event) {
        if (event.keyCode == 13 && this.text_tmp.split('\n').length >= event.target.rows) {
          event.preventDefault();
          return
        }
      }
    },


    computed: {
      boo: function() {
        if (this.session.user.has_auth) {
          return this.session.user.boo
        }
      },

      profile: function() {
        if (this.boo) {
          return this.boo.profile
        }
      },

      profilepix: function() {
        if (this.profile)
          return this.profile.pix
      },

      text: function() {
        if (this.boo) {
          return this.boo.text
        }
      },

      nick: function() {
        if (this.boo) {
          return this.boo.nick
        }
      },

      savable: function() {
        if ((this.nick_tmp == '') || (this.profilepix_tmp == undefined)) {
          return false
        }

        if (this.boo) {
          return (this.nick != this.nick_tmp) || (this.text != this.text_tmp) || (this.profilepix != this.profilepix_tmp)

        }
      }
    }
  });
</script>
