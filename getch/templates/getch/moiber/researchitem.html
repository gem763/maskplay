<style>
  .researchitem {
    /* background: white;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%; */
    overflow: hidden;
  }

  .researchitem > .backbone {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .researchitem > .backbone > .section {
    position: absolute;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .researchitem > .backbone > .section.outfocused {
    opacity: 0.2;
    filter: grayscale(1);
  }

  .researchitem > .backbone > .section.full {
    width: 100%;
    height: 100%;
  }

  .researchitem > .backbone > .section.full.intro > img {
    position: absolute;
    bottom: 16px;
    left: 16px;
    width: calc(100% - 32px);
    height: 60%;
    object-fit: cover;
    box-sizing: border-box;
    border-radius: var(--w-3);
    opacity: 0;
    transition: all 0.5s;
  }

  .researchitem > .backbone > .section.full.outro > img {
    position: absolute;
    top: 20%;
    left: 16px;
    width: calc(100% - 32px);
    height: 60%;
    object-fit: cover;
    box-sizing: border-box;
    border-radius: var(--w-3);
    opacity: 0;
    transition: all 0.5s;
  }

  .researchitem > .backbone > .section.full.intro > img.loaded {
    opacity: 1;
  }

  .researchitem > .backbone > .section.full.outro > img.loaded {
    opacity: 0.3;
  }

  .researchitem > .backbone > .section.full > .cover {
    position: absolute;
    left: 0;
    width: 100%;
    height: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    transition: all 0.3s;
  }

  .researchitem > .backbone > .section.full.intro > .cover {
    top: -50%;
    background: rgba(255,255,255,0.8);
  }

  .researchitem > .backbone > .section.full.intro > .cover.loaded {
    top: 0;
  }

  .researchitem > .backbone > .section.full.outro > .cover {
    bottom: 0;
  }

  .researchitem > .backbone > .section.full > .cover > .logo {
    width: 60px;
    height: 60px;
    background: white;
    border-radius: 100px;
    margin: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    box-sizing: border-box;
    border: 1px solid var(--color-dark);
  }

  .researchitem > .backbone > .section.full > .cover > .logo > img {
    width: 90%;
    height: auto;
  }

  .researchitem > .backbone > .section.full > .cover > span.bname {
    font-weight: bold;
    font-size: 28px;
  }

  .researchitem > .backbone > .section.full > .cover > span.category {
    font-weight: bold;
    font-size: 24px;
  }

  .researchitem > .backbone > .section.full > .cover > span.title {
    font-weight: bold;
    font-size: 28px;
    margin-top: 20px;
  }

  .researchitem > .backbone > .section.full > .cover > span.outment {
    font-size: 13px;
    margin-top: 20px;
    white-space: pre-line;
    text-align: center;
  }

  .researchitem > .backbone > .section.full > .cover > span.gogo {
    font-weight: bold;
    font-size: 11px;
    margin-top: 20px;
    background: var(--color-point);
    width: 60px;
    height: 34px;
    line-height: 34px;
    border-radius: 100px;
    text-align: center;
    color: white;
    cursor: pointer;
  }

  .researchitem > .backbone > .section.full > .cover > span.more {
    font-size: 13px;
    margin-top: 10px;
    background: #183394;
    width: 150px;
    height: 34px;
    line-height: 34px;
    border-radius: 100px;
    text-align: center;
    color: white;
    cursor: pointer;
  }


  .researchitem > .backbone > .section > .mc {
    position: absolute;
    left: 12px;
    right: 12px;
    top: 50%;
    /* height: 300px; */
    transform: translateY(-50%);
    /* background: lightpink; */
    display: flex;
    align-items: flex-start;
    justify-content: center;
    flex-wrap: wrap;
    flex-direction: row;
  }

  .researchitem > .backbone > .section.down > .mc {
    top: var(--w-1);
    transform: none;
  }

  .researchitem > .backbone > .section > .mc > .square {
    position: relative;
    width: calc(100% / 3);
    padding-top: calc(100% / 3);
    /* background: lightblue; */
  }

  .researchitem > .backbone > .section > .mc > .square > .choice {
    position: absolute;
    top: 4px;
    left: 4px;
    right: 4px;
    bottom: 4px;
    border-radius: var(--w-3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
  }

  .researchitem > .backbone > .section > .mc > .square > .choice.nopix {
    background: rgba(0, 0, 0, 0.15);
  }

  .researchitem > .backbone > .section > .mc > .square > .choice.chosen {
    background: orange;
  }

  .researchitem > .backbone > .section > .mc > .square > .choice.chosen > img.mcpix {
    opacity: 0.3;
  }

  .researchitem > .backbone > .section > .mc > .square > .choice > img.mcpix {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--w-3);
    filter: brightness(95%);
  }

  .researchitem > .backbone > .section > .mc > .square > .choice > span {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    text-align: center;
    transform: translate(-50%, -50%);
  }

  .researchitem > .backbone > .section.pix {
    width: 100%;
    height: calc(50% + var(--square-size) * 0.4);
    top: 0;
  }

  .researchitem > .backbone > .section.down-left {
    width: 50%;
    height: calc(50% - var(--square-size) * 0.4 - var(--w-15));
    bottom: var(--w-15);
    left: 0;
  }

  .researchitem > .backbone > .section.down-right {
    width: 50%;
    height: calc(50% - var(--square-size) * 0.4 - var(--w-15));
    bottom: var(--w-15);
    right: 0;
  }

  .researchitem > .backbone > .section.up {
    width: 100%;
    height: 50%;
    top: 0;
  }

  .researchitem > .backbone > .section.down {
    width: 100%;
    height: 50%;
    bottom: 0;
  }

  .researchitem > .backbone > .section > img.candidate {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    object-fit: cover;
    transition: opacity 0.3s;
    border-radius: var(--w-3);
    filter: brightness(95%);
  }

  .researchitem > .backbone > .section > img.ox {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    object-fit: cover;
    transition: opacity 0.3s;
  }


  .researchitem > .backbone > .section.pix > img.candidate {
    width: var(--square-size);
    height: calc(var(--square-size) * 1.4);
    bottom: var(--w-1);
  }

  .researchitem > .backbone > .section.down-left > img.ox {
    width: 60%;
    height: auto;
  }

  .researchitem > .backbone > .section.down-right > img.ox {
    width: 60%;
    height: auto;
  }

  .researchitem > .backbone > .section.up > img.candidate {
    width: var(--square-size);
    height: var(--square-size);
    bottom: var(--w-1);
  }

  .researchitem > .backbone > .section.down > img.candidate {
    width: var(--square-size);
    height: var(--square-size);
    top: var(--w-1);
  }

  .researchitem > .backbone > .section > .label {
    text-align: center;
    position: absolute;
    /* width: calc(var(--square-size) * 0.8); */
    left: 55px;
    /* transform: translateX(-50%); */
    border-radius: 100px;
    white-space: pre-line;
    /* padding: 5px; */
    font-size: 13px;
    background: rgba(255,255,255,0.7);
    height: 30px;
    line-height: 30px;
    padding-left: 10px;
    padding-right: 10px;
    min-width: 70px;
    box-sizing: border-box;
  }

  .researchitem > .backbone > .section.up > .label {
    bottom: calc(var(--w-1) + var(--square-size) - 40px);
  }

  .researchitem > .backbone > .section.down > .label {
    top: calc(var(--w-1) + var(--square-size) - 40px);
  }

  .researchitem > .backbone > .divider {
    position: absolute;
    width: 100%;
    height: 0;
    background: white;
    top: 50%;
    transform: translateY(-50%);
  }

  .researchitem > .backbone > .divider > .vs {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: var(--w-20);
    height: var(--w-10);
    width: var(--w-10);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 15px;
  }

  .researchitem > .header {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    /* background: rgba(255,255,255,0.9); */
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .researchitem > .header > .header-section {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .researchitem > .header > .header-section.logo {
    width: 12%;
  }

  .researchitem > .header > .header-section.question {
    width: 71%;
    font-size: 13px;
    text-align: center;
    white-space: pre-line;
  }

  .researchitem > .header > .header-section.npage {
    width: 12%;
  }

  .researchitem > .header > .header-section.logo > img {
    width: 70%;
    height: auto;
  }

  .researchitem > .header > .header-section.npage > .pagination {
    font-size: 12px;
  }
</style>


<script type='text/x-template' id='researchitem-template'>
  <div class='researchitem' ref='post'>

    <div class='backbone' v-if='is_intro'>
      <div class='section full intro'>
        <img :src='researchitem.pix.pix_0' :class='{ loaded: pix_0_loaded }' @load='pix_0_loaded=true'>

        <div class='cover' :class='{ loaded: pix_0_loaded }'>
          <div class='logo' v-if='brand'>
            <img :src='brand.logo'>
          </div>

          <span class='bname'>[[ brand.name_en ]]</span>
          <span class='category'>소비자리서치</span>
          <span class='title'>[[ researchitem.text ]]</span>
          <span class='gogo' @click='start_research'>시작하기</span>
        </div>
      </div>
    </div>


    <div class='backbone' v-if='is_outro'>
      <div class='section full outro'>
        <img :src='researchitem.pix.pix_0' :class='{ loaded: pix_0_loaded }' @load='pix_0_loaded=true'>

        <div class='cover' :class='{ loaded: pix_0_loaded }'>
          <!-- <div class='logo' v-if='brand'>
            <img :src='brand.logo'>
          </div> -->

          <span class='bname'>[[ brand.name_en ]]</span>
          <!-- <span class='outment'>[[ outment ]]</span> -->
          <span class='outment'>[[ researchitem.text ]]</span>
          <!-- <span class='more support'>후원 이벤트 참여</span> -->
          <span class='more homepage' @click='go_homepage'>브랜드 공식 사이트</span>
          <span class='more insta' @click='go_insta'>브랜드 공식 인스타</span>
        </div>
      </div>
    </div>


    <div class='backbone' v-if='is_ab'>
      <div class='section up' :class='outfocused(1)' @click='toggle_choose(0)'>
        <img class='candidate' :src='researchitem.pix.pix_0'>
        <div class='label' v-if='researchitem.pix.pixlabel_0'>[[ researchitem.pix.pixlabel_0 ]]</div>
      </div>

      <div class='section down' :class='outfocused(0)' @click='toggle_choose(1)'>
        <img class='candidate' :src='researchitem.pix.pix_1'>
        <div class='label' v-if='researchitem.pix.pixlabel_1'>[[ researchitem.pix.pixlabel_1 ]]</div>
      </div>

      <div class='divider'>
        <div class='vs'><b>VS</b></div>
      </div>
    </div>


    <div class='backbone' v-if='is_ox'>
      <div class='section pix'>
        <img class='candidate' :src='researchitem.pix.pix_0'>
      </div>

      <div class='section down-left' :class='outfocused(1)' @click='toggle_choose(0)'>
        <img class='ox' src='/static/materials/icons/moiber_letter_o.png'>
      </div>

      <div class='section down-right' :class='outfocused(0)' @click='toggle_choose(1)'>
        <img class='ox' src='/static/materials/icons/moiber_letter_x.png'>
      </div>
    </div>

    <div class='backbone' v-if='is_mc_nopix'>
      <div class='section full'>
        <div class='mc'>
          <div class='square' v-for='(c, idx) in researchitem.mc'>
            <div class='choice' :class='choice_class(c, idx)' @click='multi_choose(idx)'>
              <img class='mcpix' :src='c.mcpix' v-if='c.mcpix'>
              <span>[[ c.mclabel ? c.mclabel : '' ]]</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class='backbone' v-if='is_mc_pix'>
      <div class='section up'>
        <img class='candidate' :src='researchitem.pix.pix_0'>
      </div>

      <div class='section down'>
        <div class='mc'>
          <div class='square' v-for='(c, idx) in researchitem.mc'>
            <div class='choice' :class='choice_class(c, idx)' @click='multi_choose(idx)'>
              <img class='mcpix' :src='c.mcpix' v-if='c.mcpix'>
              <span>[[ c.mclabel ? c.mclabel : '' ]]</span>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div class='header'>
      <div class='header-section logo'></div>

      <div class='header-section question'>
        <span v-if='on_mainstory'>[[ researchitem.text ]]</span>
      </div>

      <div class='header-section npage'>
        <div class='pagination' v-if='pagination'>[[ pagination ]]</div>
      </div>
    </div>

  </div>
</script>


<script>
  Vue.component('researchitem', {
    template: '#researchitem-template',
    delimiters: ['[[', ']]'],
    props: ['researchitem', 'brand', 'session', 'swiper', 'pagination'],
    data: function() {
      return {
        status: -1,
        pix_0_loaded: false,
        pix_1_loaded: false,
        headcover_loaded: false,
        answer: [],
      }
    },

    // created: function() {
    //   this.status = this.vote_state;
    // },

    watch: {
      pix_0_loaded: function(_new, _old) {
        if (this.is_intro && _new) {
          this.$emit('intro_loaded');
        }
      },

      answer: function(_new, _old) {
        const _answer = JSON.stringify(_new);
        const _url = `research/${this.research_id}/item/${this.researchitem.id}/answer/${_answer}`;
        fetch(_url).then(x=>x.json()).then(console.log)
      }
      // vote_state: function(_new, _old) {
      //   this.status = this.vote_state;
      // }
    },


    computed: {
      research: function() {
        if (this.session.page.research.content) {
          return this.session.page.research.content
        }
      },

      research_id: function() {
        if (this.research) {
          return this.research.id
        }
      },

      is_intro: function() {
        return this.researchitem.type == 'IN'
      },

      is_outro: function() {
        return this.researchitem.type == 'OUT'
      },

      is_ab: function() {
        return this.researchitem.type == 'AB'
      },

      is_ox: function() {
        return this.researchitem.type == 'OX'
      },

      is_mc_nopix: function() {
        return (this.researchitem.type == 'MC') && (this.researchitem.pix == undefined)
      },

      is_mc_pix: function() {
        return (this.researchitem.type == 'MC') && (this.researchitem.pix != undefined)
      },

      on_mainstory: function() {
        return !this.is_intro && !this.is_outro
      }
    },

    // computed: {
    //   vote_state: function() {
    //     if (this.post) {
    //       return this.session.user.has_voted_as(this.post.id)
    //
    //     } else {
    //       return -1
    //     }
    //   }
    // },


    methods: {
      go_homepage: function() {
        window.open(this.brand.homepage);
      },

      go_insta: function() {
        window.open(this.brand.insta);
      },

      start_research: function() {
        this.swiper.slideNext();
      },

      outfocused: function(act) {
        if (this.answer.includes(act)) {
          return 'outfocused'
        }
      },

      choice_class: function(c, act) {
        return {
          chosen: this.answer.includes(act),
          nopix: !c.mcpix
        }
      },

      // chosen: function(act) {
      //   if (this.answer.includes(act)) {
      //     return 'chosen'
      //   }
      // },
      //
      // nopix: function(pix) {
      //   if (!pix) {
      //     return 'nopix'
      //   }
      // },

      multi_choose: function(act) {
        if (this.answer.includes(act)) {
          const where = this.answer.indexOf(act);
          this.answer.splice(where, 1);

        } else {
          this.answer.push(act);
        }
      },

      // toggle_choose: function(act) {
      //   // 선택을 클리어하는 경우
      //   if (this.status==act) {
      //     this.status = -1;
      //     // this.session.user.contentvote(this.post.id, -1);
      //
      //   } else {
      //     this.status = act;
      //     // this.session.user.contentvote(this.post.id, act);
      //     // setTimeout(() => { this.swiper.slideNext() }, 300);
      //   }
      // },

      toggle_choose: function(act) {
        if (this.answer.includes(act)) {
          this.answer.splice(0); // 완전히 비우기
          // const where = this.answer.indexOf(act);
          // this.answer.splice(where, 1);

        } else {
          this.answer.splice(0); // 완전히 비우기
          this.answer.push(act);
        }
      }
    }
  });
</script>
