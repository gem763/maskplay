<style>
  .tagchooser.vcomp {
    position: relative;
    width: 100%;
    height: 100%;
    /* background: white; */
    background: #f8f8f8;
    padding-top: 45px;
    padding-bottom: var(--dasher-height);
    box-sizing: border-box;
  }

  .tagchooser.vcomp > .divider {
    position: absolute;
    width: 100%;
    height: 0;
    background: white;
    /* top: 50%; */
    top: calc((100% - 45px - var(--dasher-height))/2 + 45px);
    transform: translateY(-50%);
  }

  .tagchooser.vcomp > .divider > .vs {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: var(--w-20);
    height: 45px;
    width: 45px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
  }

  .tagchooser.vcomp > .divider > .vs > * {
    transform: translateY(2px);
    letter-spacing: -1px;
  }

  .tagchooser.vcomp > .section {
    /* position: absolute; */
    position: relative;
    width: 100%;
    height: 50%;
    pointer-events: none;
    /* background: #f8f8f8; */
  }

  .tagchooser.vcomp.loaded > .section {
    pointer-events: auto;
  }

  .tagchooser.vcomp > .section.outfocused {
    opacity: 0.2;
    filter: grayscale(1);
  }

  .tagchooser.vcomp > .section.up {
    /* bottom: 50%; */
    /* background: white; */
  }

  .tagchooser.vcomp > .section.down {
    /* top: 50%; */
    /* background: white; */
  }

  .tagchooser.vcomp > .section > .pix {
    position: absolute;
    left: 50%;
    width: var(--square-size);
    height: var(--square-size);
    transform: translateX(-50%);
    /* object-fit: cover; */
    transition: opacity 0.3s;
    border-radius: var(--w-3);
    filter: brightness(95%);
    opacity: 0;
    overflow: hidden;
  }

  .tagchooser.vcomp.loaded > .section > .pix {
    opacity: 1;
  }

  .tagchooser.vcomp.loaded > .section.up > .pix {
    bottom: 1px;
  }

  .tagchooser.vcomp.loaded > .section.down > .pix {
    top: 1px;
  }

  .tagchooser.vcomp > .section > .pix > img {
    position: absolute;
  }

  .tagchooser.vcomp > .section > .pix > .tag {
    position: absolute;
    width: 4%;
    height: 4%;
    /* opacity: 0.5; */
    /* transform: translate(50%, -200%); */
    border-radius: 100px;
    border: 3px solid white;
    background: var( --color-point);
  }

  .tagchooser.vcomp > .section > .pix > .tag > .label {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    font-size: 10px;
    color: var(--color-point);
    width: 100px;
    transform: translateX(-50%);
    text-align: center;
  }

  .tagchooser.vcomp > .section > .pix > .tag > .label > .label-text {
    background: rgba(0,0,0,0.6);
    padding: 0px;
    color: white;
  }

  .tagchooser.vcomp > .section > .pix > .label {
    text-align: center;
    position: absolute;
    left: calc((100% - var(--square-size)) / 2 + 8px);
    border-radius: 15px;
    white-space: pre-line;
    font-size: 13px;
    background: rgba(255,255,255,0.7);
    height: 30px;
    line-height: 30px;
    padding-left: 10px;
    padding-right: 10px;
    min-width: 70px;
    box-sizing: border-box;
  }

  .tagchooser.vcomp > .section.up > .pix > .label {
    top: 8px;
    /* bottom: calc(min(var(--width) - 90px, (var(--height) - 60px - 32px - var(--iphone-bottom))/2) - 38px); */
  }

  .tagchooser.vcomp > .section.down > .pix > .label {
    bottom: 8px;
    /* top: calc(min(var(--width) - 90px, (var(--height) - 60px - 32px - var(--iphone-bottom))/2) - 38px); */
  }

  .tagchooser.vcomp > .section > .more {
    position: absolute;
    width: 45px;
    height: 45px;
    /* background: orange; */
    right: calc(50% - var(--square-size)/2);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .tagchooser.vcomp > .section.up > .more {
    /* bottom: calc(var(--square-size) - 44px); */
    bottom: 1px;
  }

  .tagchooser.vcomp > .section.down > .more {
    /* top: 1px; */
    top: calc(var(--square-size) - 44px);
  }

  .tagchooser.vcomp > .section > .more > img {
    width: 14px;
    height: 14px;
    object-fit: contain;
    /* background: rgba(255,255,255,0.3); */
    border-radius: 50%;
  }

  .tagchooser.vcomp > img.loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 45px;
    height: auto;
    opacity: 1;
  }


  .tagchooser.vcomp.loaded > img.loading {
    opacity: 0;
  }


  .tagchooser.vcomp > .arrows {
    position: absolute;
    /* bottom: 50%; */
    top: calc((100% - 45px - var(--dasher-height))/2 + 45px);
    height: 0;
    left: 0;
    width: 100%;
    background: orange;
  }

  .tagchooser.vcomp > .arrows > .arrow {
    position: absolute;
    top: 50%;
    width: 45px;
    height: 45px;
    /* background: orange; */
    transform: translateY(-50%);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }

  .tagchooser.vcomp > .arrows > .arrow.left {
    left: 0;
  }

  .tagchooser.vcomp > .arrows > .arrow.right {
    right: 0;
  }

  .tagchooser.vcomp > .arrows > .arrow > img {
    width: 6px;
    height: auto;
  }

  .tagchooser.vcomp > .arrows > .arrow.left > img {
    transform: rotate(180deg);
  }
</style>

<script type='text/x-template' id='tagchooser-template'>
  <div class='tagchooser vcomp' :class='{ loaded: loaded }'>
    <img class='loading' src='/static/materials/logos/moiber_logo_splash.gif'>

    <div class='section up' :class='status==1 ? "outfocused" : ""' @click='toggle_choose(0)'>
      <div class='pix'>
        <img :src='pix_src_0' :style='pix_0_style' @load='pixloaded(0, $event)'>
        <div class='tag' :style='tag_0_style'>
          <div class='label' :style='tag_0_label_style' v-if='tag_0_label'><span class='label-text'>[[ tag_0_label ]]</span></div>
        </div>
        <!-- <div class='label' v-if='tag_0_label'>[[ tag_0_label ]]</div> -->
      </div>

      <div class='more' v-if='pixloaded_0' @click.stop='session.open_search(pix_0)'><img src='/static/materials/icons/seemore.png'></div>
    </div>

    <div class='section down' :class='status==0 ? "outfocused" : ""' @click='toggle_choose(1)'>
      <div class='pix'>
        <img :src='pix_src_1' :style='pix_1_style' @load='pixloaded(1, $event)'>
        <div class='tag' :style='tag_1_style'>
          <div class='label' :style='tag_1_label_style' v-if='tag_1_label'><span class='label-text'>[[ tag_1_label ]]</span></div>
        </div>
        <!-- <div class='label' v-if='tag_1_label'>[[ tag_1_label ]]</div> -->
      </div>
      <div class='more' v-if='pixloaded_1' @click.stop='session.open_search(pix_1)'><img src='/static/materials/icons/seemore.png'></div>
    </div>

    <div class='divider' v-if='loaded'>
      <div class='vs'>VS</div>
    </div>

    <div class='arrows'>
      <div class='arrow left' v-if='!is_first' @click.stop='go_prev'>
        <img src='/static/materials/icons/button-backward.png'>
      </div>

      <div class='arrow right' @click.stop='go_next'>
        <img src='/static/materials/icons/button-backward.png'>
      </div>
    </div>
  </div>
</script>


<script>
  Vue.component('tagchooser', {
    template: '#tagchooser-template',
    delimiters: ['[[', ']]'],
    props: [ 'tagpair', 'swiper', 'session' ],
    data: function() {
      return {
        status: -1,
        pixloaded_0: false,
        pixloaded_1: false,
        pix_0_w: undefined,
        pix_0_h: undefined,
        pix_1_w: undefined,
        pix_1_h: undefined
      }
    },

    computed: {
      loaded: function() {
        return this.pixloaded_0 && this.pixloaded_1
      },

      is_first: function() {
        if (this.swiper) {
          return this.swiper.isBeginning
        }
      },

      tag_0: function() {
        return this.tagpair.list[0]
      },

      tag_1: function() {
        return this.tagpair.list[1]
      },

      pix_0: function() {
        if (this.tag_0) {
          return this.tag_0.pix
        }
      },

      pix_1: function() {
        if (this.tag_1) {
          return this.tag_1.pix
        }
      },

      pix_src_0: function() {
        if (this.pix_0) {
          return this.pix_0.src
        }
      },

      pix_src_1: function() {
        if (this.pix_1) {
          return this.pix_1.src
        }
      },

      tag_0_x: function() {
        if (this.tag_0) {
          return this.tag_0.x
        }
      },

      tag_0_y: function() {
        if (this.tag_0) {
          return this.tag_0.y
        }
      },

      tag_1_x: function() {
        if (this.tag_1) {
          return this.tag_1.x
        }
      },

      tag_1_y: function() {
        if (this.tag_1) {
          return this.tag_1.y
        }
      },

      tag_0_label: function() {
        if (this.tag_0) {
          return this.tag_0.item
          // if (this.tag_0.category == this.tag_0.item) {
          //   return this.tag_0.category
          //
          // } else {
          //   return `${this.tag_0.category} > ${this.tag_0.item}`
          // }
        }
      },

      tag_1_label: function() {
        if (this.tag_1) {
          return this.tag_1.item
          // if (this.tag_1.category == this.tag_1.item) {
          //   return this.tag_1.category
          //
          // } else {
          //   return `${this.tag_1.category} > ${this.tag_1.item}`
          // }
        }
      },

      pix_0_style: function() {
        return this.pix_style(0)
      },

      pix_1_style: function() {
        return this.pix_style(1)
      },

      tag_0_style: function() {
        return this.tag_style(0)
      },

      tag_1_style: function() {
        return this.tag_style(1)
      },

      tag_0_label_style: function() {
        return this.tag_label_style(0)
      },

      tag_1_label_style: function() {
        return this.tag_label_style(1)
      }
    },

    methods: {
      pixloaded: function(idx, event) {
        this['pixloaded_'+idx] = true;
        const imgtag = event.target;
        this[`pix_${idx}_w`] = imgtag.naturalWidth;
        this[`pix_${idx}_h`] = imgtag.naturalHeight;
        // console.log(imgtag, imgtag.naturalWidth, imgtag.naturalHeight);
      },

      go_next: function() {
        if (this.swiper) {
          this.swiper.slideNext();
        }
      },

      go_prev: function() {
        if (this.swiper) {
          this.swiper.slidePrev();
        }
      },

      toggle_choose: function(act) {
        if (!this.session.user.has_auth) {
          const answer = confirm('로그인이 필요합니다');
          if (answer) {
            this.session.open_login();
          }

          return

        } else if (!this.session.user.boo.loaded) {
          alert('사용자 데이터를 로딩 중입니다');
          return
        }

        // let itag_pos, itag_neg;
        let type;
        const itag_pos = this[`tag_${act}`].id;
        const itag_neg = this[`tag_${1-act}`].id;

        // 선택을 클리어하는 경우
        if (this.status==act) {
          type = 'clear';
          this.status = -1;

        } else {
          // 완전히 새로 선택하는 경우
          if (this.status==-1) {
            type = 'new';

          // 반대 것을 선택하는 경우
          } else {
            type = 'change';
          }

          this.status = act;
          setTimeout(() => { this.swiper.slideNext() }, 300);
        }

        this.session.user.boo.balancegame_vote(itag_pos, itag_neg, type);
      },

      pix_style: function(idx) {
        const pixloaded = this[`pixloaded_${idx}`];
        const pix_w = this[`pix_${idx}_w`];
        const pix_h = this[`pix_${idx}_h`];
        const tag_x = this[`tag_${idx}_x`];
        const tag_y = this[`tag_${idx}_y`];

        if (pixloaded && pix_w && pix_h && tag_x && tag_y) {
          const _style = {};

          if (pix_w > pix_h) {
            _style.height = '100%';
            _style.width = (pix_w / pix_h * 100) + '%';

          } else {
            _style.width = '100%';
            _style.height = (pix_h / pix_w * 100) + '%';
          }

          if (tag_x < 0.2) {
            _style.left = 0;

          } else if (tag_x > 0.8) {
            _style.right = 0;

          } else {
            _style.left = `calc((100% - ${_style.width}) / 2)`;
          }

          if (tag_y < 0.2) {
            _style.top = 0;

          } else if (tag_y > 0.8) {
            _style.bottom = 0;

          } else {
            _style.top = `calc((100% - ${_style.height}) / 2)`;
          }

          return _style
        }
      },

      tag_style: function(idx) {
        const pixloaded = this[`pixloaded_${idx}`];
        const pix_w = this[`pix_${idx}_w`];
        const pix_h = this[`pix_${idx}_h`];
        const tag_x = this[`tag_${idx}_x`];
        const tag_y = this[`tag_${idx}_y`];

        if (pixloaded && pix_w && pix_h && tag_x && tag_y) {
          const _style = {};

          if (pix_w > pix_h) {
            _style.top = (tag_y * 100) + '%';

            if (tag_x < 0.2) {
              _style.left = (pix_w * tag_x / pix_h * 100) + '%';

            } else if (tag_x > 0.8) {
              // _style.right = (this.pix_0_w * (1 - this.tag_0_x) / this.pix_0_h * 100) + '%';
              _style.left = ((pix_w * tag_x - (pix_w - pix_h) / 1) / pix_h * 100) + '%';

            } else {
              _style.left = ((pix_w * tag_x - (pix_w - pix_h) / 2) / pix_h * 100) + '%';
            }

          } else {
            _style.left = (tag_x * 100) + '%';

            if (tag_y < 0.2) {
              _style.top = (pix_h * tag_y / pix_w * 100) + '%';

            } else if (tag_y > 0.8) {
              // _style.bottom = (this.pix_0_h * (1 - this.tag_0_y) / this.pix_0_w * 100) + '%';
              _style.top = ((pix_h * tag_y - (pix_h - pix_w) / 1) / pix_w * 100) + '%';

            } else {
              _style.top = ((pix_h * tag_y - (pix_h - pix_w) / 2) / pix_w * 100) + '%';
            }
          }

          if (tag_x > 0.8) {
            _style.transform = 'translateX(-150%)';

          } else {
            _style.transform = 'translateX(50%)';
          }

          if (tag_y < 0.2) {
            _style.transform += 'translateY(50%)';

          } else {
            _style.transform += 'translateY(-150%)';
          }



          // if ((tag_x < 0.2) && (tag_y < 0.2)) {
          //   _style.transform = 'translate(50%, 50%)';
          //
          // } else if ((tag_x < 0.2) && (tag_y > 0.8)) {
          //   _style.transform = 'translate(50%, -150%)';
          //
          // } else if ((tag_x > 0.8) && (tag_y < 0.2)) {
          //   _style.transform = 'translate(-150%, 50%)';
          //
          // } else if ((tag_x > 0.8) && (tag_y > 0.8)) {
          //   _style.transform = 'translate(-150%, -150%)';
          //
          // } else {
          //   _style.transform = 'translate(50%, -150%)';
          // }

          return _style
        }
      },

      tag_label_style: function(idx) {
        const tag_y = this[`tag_${idx}_y`];

        if (tag_y) {
          const _style = {};

          if (tag_y < 0.2) {
            _style.top = 'calc(100% + 8px)';

          } else {
            _style.bottom = 'calc(100% + 6px)';
          }

          return _style
        }
      }
    }
  });
</script>
