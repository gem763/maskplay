{% extends "getch/basepage.html" %}

{% block style %}
{{ block.super }}
<style>
  :root {
    --canvas-size: calc(var(--window-w) * 0.7);
    --profiler-top: 20%;
    --profiler-mid: var(--canvas-size);
    --profiler-bottom: calc(100% - var(--profiler-top) - var(--profiler-mid));
  }

  .profiler {
    background: white;
    width: 100%;
    height: 100%;
    position: relative;
  }

  .profiler input.toggler {
    display: none;
    visibility: hidden;
  }

  .profiler .top {
    height: var(--profiler-top);
    width: 100%;
    position: relative;
    background: none;
  }

  .profiler .nick {
    position: absolute;
    bottom: 7px;
    left: 50%;
    width: var(--canvas-size);
    transform: translate(-50%,0);
    text-align: left;
  }


  [contenteditable]:focus {
    outline: none;
  }

  .profiler .nick span {
    background: black;
    color: white;
    font-size: 25px;
    font-weight: bold;
    line-height: 30px;
  }

  .profiler .mid {
    background: none;
    height: var(--profiler-mid);
    text-align: center;
  }

  .profiler .profile-canvas {
    position: relative;
    width: var(--canvas-size);
    height: 100%;
    background: none;
    display: inline-block;
    overflow: hidden;
    /* border: 5px solid red; */
  }

  .profiler .profile-canvas .maskbar {
    position: absolute;
    top: 20%;
    left: 0;
    right: 0;
    height: 20%;
    background: white;
    /* border: var(--border); */
    text-align: center;
    opacity: 0;
    transition: opacity 0.1s;
  }

  .profiler .profile-canvas .toggler:checked + .maskbar {
    opacity: 1;
  }

  .profiler .profile-canvas .maskbar .eye-mask {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profiler .profile-canvas .canvas-border {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: none;
    border: var(--border);
    pointer-events: none;
  }

  .profiler .profile-canvas img.profilepix {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profiler .bottom {
    /* height: var(--profiler-bottom); */
    padding-top: 20px;
    position: relative;
    background: none;
  }

  .profiler .selector {
    background: none;
    border: var(--border);
    position: relative;
    overflow: hidden;
  }

  .profiler .selector table.selectbase {
    border-collapse: collapse;
    width: 100%;
    height: 100%;
    table-layout: fixed;
  }

  .profiler .selector table.selectbase.eye-masks {
    position: absolute;
    top: 100%;
    transition: top 0.1s;
  }

  .profiler .selector table.selectbase td {
    position: relative;
    padding: 0;
    border: none;
    height: 50px;
    overflow: scroll;
    white-space: nowrap;
    font-size: 0;
    /* span.inline-block 사이에 여백을 줄이기 위함: https://norux.me/63 */
    background: white;
  }

  .profiler .selector table.selectbase td.pixloader,
  .profiler .selector table.selectbase td.txtloader {
    width: 50px;
    overflow: hidden;
  }

  .profiler .selector table.selectbase td .item {
    width: 50px;
    height: 50px;
    display: inline-block;
    text-align: center;
    line-height: 50px;
  }

  .profiler .selector table.selectbase td .item.wide {
    width: 120px;
  }

  .profiler .selector table.selectbase td .item img {
    vertical-align: middle;
  }

  .profiler .selector table.selectbase td .item img.icon {
    width: 35px;
    height: 35px;
    object-fit: contain;
  }

  .profiler .selector table.selectbase td .item img.fit {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .profiler .selector table.selectbase td .item img.mask {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profiler .selector table.selectbase td .item span.txt {
    background: black;
    color: white;
    font-size: 20px;
  }

  .profiler .selector .toggler:checked + table.selectbase {
    top: 0;
  }

  .profiler table.options {
    border-collapse: collapse;
    width: 80%;
    position: absolute;
    top: calc(100% - var(--border-w));
    left: 50%;
    transform: translateX(-50%);
  }

  .profiler table.options td.option {
    width: 40px;
    height: 40px;
    border: var(--border);
    text-align: center;
    padding: 0;
  }

  .profiler table.options td.option.coloring {
    background: rgb(241,20,15);
  }

  .profiler table.options td.option img.icon {
    width: 30px;
    height: 30px;
    vertical-align: middle;
    object-fit: contain;
  }

  .profiler table.options td.option.texting span {
    background: black;
    color: white;
    font-size: 15px;
  }

  .profiler .save {
    position: absolute;
    bottom: 30px;
    left: 50%;
    width: 80%;
    height: 45px;
    background: black;
    transform: translateX(-50%);
    border: var(--border);
    box-sizing: border-box;
    color: white;
    text-align: center;
    line-height: 45px;
  }
</style>
{% endblock style %}

{% block page %}
<div class='profiler'>

  <div class='top'>
    <div class='nick'>
      <span>{{user.boo.nick}}</span>
    </div>
  </div>


  <div class='mid'>
    <div class='profile-canvas'>
      <input type="file" name="image" accept="image/*" style="display:none;" id="profilepix-load" onchange="load_img(this)">
      <img class='profilepix' src='{{user.boo.profile.pix.url}}'>

      <input class='maskbar toggler' type='checkbox'>
      <div class='maskbar'>
        <img class='eye-mask' src='/static/materials/imgs/masks/eyes/{{imgs.eye_masks.0}}'>
      </div>

      <!-- <div class='canvas-border'></div> -->
    </div>
  </div>

  <div class='bottom'>
    <div class='selector'>
      <table class='selectbase'>
        <tbody>
          <tr>
            <td class='pixloader'>
              <label class='item' for='profilepix-load'>
                <img class='icon' src='/static/materials/icons/pix.png'>
              </label>
            </td>
            <td class='txtloader'>
              <div class='item'>
                <span class='txt'>히</span>
              </div>
            </td>
            <td>
              {% for ch in imgs.characters %}
              <div class='item' onclick='characterize(this)'>
                <img class='fit' src='/static/materials/imgs/characters/{{ch}}'>
              </div>
              {% endfor %}
            </td>
          </tr>
        </tbody>
      </table>

      <input class='selmask toggler' type='checkbox'>
      <table class='selectbase eye-masks'>
        <tbody>
          <tr>
            <td>
              {% for emask in imgs.eye_masks %}
              <div class='item wide' onclick='eye_maskup(this)'>
                <img class='mask' src='/static/materials/imgs/masks/eyes/{{emask}}'>
              </div>
              {% endfor %}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <table class='options'>
      <tbody>
        <tr>
          <td class='option masking' onclick='toggle_masking()'><img class='icon' src='/static/materials/icons/mask4.png'></td>
          <td class='option coloring'></td>
          <td></td>
          <td class='option texting'><span>Aa</span></td>
          <td class='option clipping'><img class='icon' src='/static/materials/icons/arrow_down.png'></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class='save' onclick='save()'>SAVE</div>
  <a id="target" style="display: none"></a>

  <img id='testimg' src='/static/materials/imgs/마블리.jpg' style='position:absolute;top:5px;right:5px;width:150px;height:150px;object-fit:cover;'>
</div>
{% endblock page %}


{% block js %}
{{ block.super }}
<script>
  document.querySelector('.profiler .nick span').contentEditable = 'true';

  function imgerr(img) {
    img.style.display = 'none';
  }

  function load_img(input) {
    if (input.files && input.files[0]) {
      let reader = new FileReader();

      reader.onload = function(e) {
        let img = $(input).next('img');  // 여기서는 jquery가 되네; 희안하다 (함수 안에서는 되는듯)
        img.attr("src", e.target.result);
        // img.parent().css("display", "block");
      }

      reader.readAsDataURL(input.files[0]);
    }
  }

  function eye_mask(mask_img) {
    let src = mask_img.src;
    document.querySelector('.profiler-canvas img.mask').src = src;
  }

  function eye_maskup(td) {
    let src = td.querySelector('img').src;
    document.querySelector('.profile-canvas .maskbar img.eye-mask').src = src;
  }

  function characterize(td) {
    let src = td.querySelector('img').src;
    document.querySelector('.profile-canvas img.profilepix').src = src;
  }


  function toggle_masking() {
    let selmask = document.querySelector('input.toggler.selmask')
    selmask.checked = !selmask.checked;

    let maskbar = document.querySelector('input.toggler.maskbar')
    maskbar.checked = !maskbar.checked;
  }

  function save() {
    html2canvas(document.querySelector('.profile-canvas')).then(function(canvas) {
      document.querySelector('#testimg').src = canvas.toDataURL("image/png");
      // if (navigator.msSaveBlob) {
      //   var blob = canvas.msToBlob();
      //   return navigator.msSaveBlob(blob, '파일명.png');
      // } else {
      //   var el = document.getElementById("target");
      //   el.href = canvas.toDataURL("image/png");
      //   el.download = '파일명.jpg';
      //   el.click();
      // }

      canvas.toBlob(function(blob) {
        const formData = new FormData();
        formData.append('pix', blob, 'mypix.png');
        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');

        fetch('boo/profile/save/', { method: 'POST', body: formData })
          .then(res => res.json())
          .then(js => { console.log(js); });
      });
    });
  }

</script>
{% endblock js %}
