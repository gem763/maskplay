{% include "getch/page.html" %}
{% include "getch/struct.html" %}
{% include "getch/profilekit.html" %}
{% include "getch/editext.html" %}

<style>
  .profiler.vcomp .struct .header-0 > .canvas {
    position: absolute;
    top: 10%;
    left: 10%;
    width: 80%;
    height: 80%;
    background: white;
    /* overflow: hidden; */
    border: 1px solid black;
    box-sizing: border-box;
  }

  .profiler.vcomp .struct .header-0 > .canvas > .subcanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    background-size: cover;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .profiler.vcomp .struct .header-0 > .canvas > .subcanvas.text {
    background: black;
  }

  .profiler.vcomp .struct .header-0 > .canvas > .mask {
    position: absolute;
    background: none;
    background-size: contain;
    background-position: center center;
    background-repeat: no-repeat;
    text-align: center;
    outline: 1px solid black;
  }

  .profiler.vcomp .struct .header-0 > .canvas > .mask > img.remover {
    position: absolute;
    top: 0;
    right: 100%;
    width: 20px;
    height: 20px;
  }

  .profiler.vcomp .struct .header-0 > .canvas > .eyemask.mask {
    background-color: rgba(173,216,230,0.5);
  }

  .profiler.vcomp .struct .header-0 > .canvas > .mouthmask.mask {
    background-color: rgba(255,182,193,0.5);
  }

  .profiler.vcomp .saver {
    position: absolute;
    bottom: 0;
    right: 30%;
    left: 30%;
    width: 40%;
    top: var(--window-h2);
    background: black;
    color: white;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>


<script type='text/x-template' id='profiler-template'>
  <page class='profiler vcomp' :open='session.page.profiler.open' :from='session.page.profiler.from' @close='session.close_page()'>

    <struct>
      <template #header-0>
        <div class='canvas' ref='canvas'>
          <div class='subcanvas character' v-show='is_characterized' :style='character_canvas_style'></div>
          <div class='subcanvas image' v-show='is_imagized' :style='image_canvas_style'></div>
          <div class='subcanvas text' v-show='is_textized'>
            <editext ref='boo_profile_text' :rawtext='boo.profile.text' :editable='true' placeholder='ㅋㅋ' type='in-profile-texting'></editext>
          </div>

          <div class='mask eyemask' ref='eyemask' v-show='is_eyemasked && (!is_textized)' :style='eyemask_style'>
            <img class='remover' src='/static/materials/icons/times.png' @click='remove("eyemask")'>
          </div>

          <div class='mask mouthmask' ref='mouthmask' v-show='is_mouthmasked && (!is_textized)' :style='mouthmask_style'>
            <img class='remover' src='/static/materials/icons/times.png' @click='remove("mouthmask")'>
          </div>
        </div>
      </template>

      <template #header-1>
        <editext ref='boo_text' :rawtext='boo.text' :header='boo.nick' :editable='true' placeholder='NICKNAME HERE' type='in-boo-texting'></editext>
      </template>

      <template #content>
        <profilekit
          :boo='boo'
          :session='session'
          :characters='characters'
          :eyemasks='eyemasks'
          :mouthmasks='mouthmasks'
        ></profilekit>
      </template>
    </struct>

    <div class='saver' @click='save'>SAVE</div>

  </page>
</script>


<script>
  Vue.component('profiler', {
    template: '#profiler-template',
    delimiters: ['[[', ']]'],
    props: ['session'],
    data: function() {
      return {
        boo: _.cloneDeep(this.session.auth.boo),
        characters: {{ characters|safe }},
        eyemasks: {{ eyemasks|safe }},
        mouthmasks: {{ mouthmasks|safe }}
      }
    },

    // created: function() {
    //   let maskbases = {{ maskbases|safe }};
    //   maskbases = _.groupBy(maskbases, maskbase => maskbase.type);
    //   this.eyemasks = maskbases.EYE;
    //   this.mouthmasks = maskbases.MOUTH;
    // },

    methods: {
      remove: function(mask) {
        this.boo.profile[mask].masked = false;
      },

      save: function() {
        const kk = _diff2(this.session.auth.boo, this.boo);
        console.log(kk);
      }
    },

    mounted: function() {
      this.$watch(
        function() {
          return this.$refs.boo_text.text
        },

        function(_new, _old) {
          this.boo.text = _new;
        },
      );

      this.$watch(
        function() {
          return this.$refs.boo_profile_text.text
        },

        function(_new, _old) {
          this.boo.profile.text = _new;
        },
      );

      const self = this;
      $(this.$refs.eyemask).draggable({
        axis: 'y',
        containment: 'parent',
        stop: function(event, ui) {
          const canvas = self.$refs.canvas;
          const eyemask = self.$refs.eyemask;
          self.boo.profile.eyemask.top = ui.position.top / canvas.clientHeight * 100;
          // self.boo.profile.eyemask.left = ui.position.left / canvas.clientWidth * 100;
          // self.boo.profile.eyemask.height = eyemask.clientHeight / canvas.clientHeight * 100;
          // self.boo.profile.eyemask.width = eyemask.clientWidth / canvas.clientWidth * 100;
        }
      });

      $(this.$refs.mouthmask).draggable({
        axis: 'y',
        containment: 'parent',
        stop: function(event, ui) {
          const canvas = self.$refs.canvas;
          const mouthmask = self.$refs.mouthmask;
          self.boo.profile.mouthmask.top = ui.position.top / canvas.clientHeight * 100;
          // self.boo.profile.mouthmask.left = ui.position.left / canvas.clientWidth * 100;
          // self.boo.profile.mouthmask.height = mouthmask.clientHeight / canvas.clientHeight * 100;
          // self.boo.profile.mouthmask.width = mouthmask.clientWidth / canvas.clientWidth * 100;
        }
      });
    },

    computed: {
      is_characterized: function() {
        return (this.boo.profile.type=="CHARACTER")
      },

      is_imagized: function() {
        return (this.boo.profile.type=="IMAGE")
      },

      is_textized: function() {
        return (this.boo.profile.type=="TEXT")
      },

      is_eyemasked: function() {
        return this.boo.profile.eyemask.masked
      },

      is_mouthmasked: function() {
        return this.boo.profile.mouthmask.masked
      },

      character_canvas_style: function() {
        return {
          backgroundImage: `url(${this.characters[this.boo.profile.character].pix})`
        }
      },

      image_canvas_style: function() {
        return {
          backgroundImage: `url(${this.boo.profile.image})`
        }
      },

      eyemask_style: function() {
        return {
          backgroundImage: `url(${this.eyemasks[this.boo.profile.eyemask.maskbase].pix})`,
          top: this.boo.profile.eyemask.top + '%',
          left: this.boo.profile.eyemask.left + '%',
          width: this.boo.profile.eyemask.width + '%',
          height: this.boo.profile.eyemask.height + '%'
        }
      },

      mouthmask_style: function() {
        return {
          backgroundImage: `url(${this.mouthmasks[this.boo.profile.mouthmask.maskbase].pix})`,
          top: this.boo.profile.mouthmask.top + '%',
          left: this.boo.profile.mouthmask.left + '%',
          width: this.boo.profile.mouthmask.width + '%',
          height: this.boo.profile.mouthmask.height + '%'
        }
      },
    }
  });
</script>
