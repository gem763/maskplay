<style>
  .profiler.vcomp .page-body > .profiler-body {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    overflow-y: auto;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles {
    background: none;
    margin-top: var(--w-16);
    margin-bottom: var(--w-20);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile {
    width: var(--w-33);
    height: var(--w-33);
    background: none;
    transition: all 0.5s;
    position: relative;
    /* border-radius: 50%; */
    /* border: 1px solid whitesmoke; */
    box-sizing: border-box;
    /* overflow: hidden; */
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile > * {
    pointer-events: none;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile.new {
    background: var(--color-dark);
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile > img.profilepix {
    width: 100%;
    height: 100%;
    object-fit: contain;
    /* border-radius: 50%;
    border: 1px solid whitesmoke;
    box-sizing: border-box; */
    /* opacity: 0.5; */
    border-radius: 50%;
    /* background: orange; */
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile > .profilepix-editor {
    position: absolute;
    width: 25%;
    height: 25%;
    pointer-events: none;
    bottom: 0;
    right: 0;
    background: white;
    border-radius: 20%;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    /* pointer-events: auto; */
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .profile > .profilepix-editor > img.icon {
    width: 60%;
    height: 60%;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick {
    font-size: 15px;
    margin-top: 20px;
    position: relative;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .text {
    font-size: 13px;
    margin-top: 15px;
    white-space: pre-line;
    text-align: center;
    position: relative;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > .edit,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > .edit {
    position: absolute;
    top: 50%;
    left: 110%;
    transform: translateY(-50%);
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > span > img,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > span > img {
    width: 14px;
    height: auto;
    /* height: 11px; */
    margin-left: 5px;
    pointer-events: none;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .nick > span.tmp,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .text > span.tmp {
    color: lightgray;
  }


  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels-shower {
    margin-top: 40px;
    font-size: 13px;
    text-align: center;
    width: 100%;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels-shower > * {
    pointer-events: none;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels-shower > img {
    width: var(--w-4);
    height: auto;
    transform: rotate(180deg);
    margin-top: 10px;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels {
    margin-top: 10px;
    width: var(--w-90);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .gender.labels {
    margin-top: 30px;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels > .title {
    font-size: 15px;
    margin-top: 20px;
    margin-bottom: 5px;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels > .labels-guide {
    font-size: 11px;
    color: lightgray;
    margin-top: 10px;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels > .label,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label {
    font-size: 13px;
    padding: 7px;
    border-radius: 20px;
    margin: 2px;
    border: 2px solid lightgray;

    display: flex;
    align-items: center;
    justify-content: center;
    height: 30px;
    box-sizing: border-box;
    position: relative;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label > .action {
    position: absolute;
    top: 50%;
    width: 25px;
    height: 25px;
    transform: translateY(-50%);
    /* background: lightpink; */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label > .action.edit {
    left: 105%;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label > .action.delete {
    left: calc(105% + 25px);
    opacity: 1;
  }

  /* .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label > .action.delete.active {
    opacity: 1;
  } */

  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label > .action > img.icon {
    width: 50%;
    height: auto;
    pointer-events: none;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels > .label.selected,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label.selected {
    color: red;
    border: 2px solid red;
    box-shadow: 0 2px 4px rgba(70, 71, 105, 0.2);
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels > .label.more,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label.del,
  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link > .label.add {
    border: none;
  }

  /* .profiler.vcomp .page-body > .profiler-body > .profiles > .styletags > .tag.selected {
    background: var(--color-dark);
    color: white;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .fashiontems > .item.selected {
    background: #292A4D;
    color: white;
  } */

  .profiler.vcomp .page-body > .profiler-body > .profiles > .labels > .labels_divider {
    flex-basis: 100%;
    height: 0;
    margin: 0;
    border: 0;
  }


  .profiler.vcomp .page-body > .profiler-body > .profiles > .links {
    /* background: lightpink; */
    margin-top: 10px;
    width: var(--w-90);
    text-align: center;
    /* height: 100px; */
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .link {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
  }

  .profiler.vcomp .page-body > .profiler-body > .profiles > .links > .title {
    font-size: 15px;
    margin-top: 20px;
    margin-bottom: 5px;
  }


  .profiler.vcomp .page-body > .profiler-body > .actions {
    position: fixed;
    bottom: 0;
    /* left: 0; */
    width: var(--width);
    height: var(--w-16);
    background: white;
    font-size: 15px;
    color: var(--color-inactive);
    /* font-weight: bold; */
    display: flex;
    align-items: center;
    justify-content: center;
    border-top: 1px solid lightgray;
  }

  .profiler.vcomp .page-body > .profiler-body > .actions.cancelable {
    justify-content: space-between;
  }

  .profiler.vcomp .page-body > .profiler-body > .actions > .action {
    background: none;
    padding-left: var(--w-6);
    padding-right: var(--w-6);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .profiler.vcomp .page-body > .profiler-body > .actions > .done.action.active {
    color: red;
  }
</style>


<script type='text/x-template' id='profiler-template'>
  <page2
    class='profiler vcomp'
    :open='session.page.profiler.open'
    :from='session.page.profiler.from'
    :onloading='on_creating'
    :hide_close='is_first_profiling'
    @close='session.close_page()'>

    <template #headerbar-menu>
      <div class='item' @click='delboo' v-if='deletable'>부캐 삭제</div>
    </template>

    <template #headerbar-body-trans>
      <!-- <div class='profile'>
        <img :src='boo.profile.pix'>
      </div> -->
    </template>

    <template #headerbar-body-default>
    </template>


    <template #page-body>
      <div class='profiler-body' v-if='boo'>

        <div class='profiles' ref='profiles'>
          <!-- <div class='profile' :class='profilepix ? "" : "new"' @click='load_pixeditor'> -->
          <div class='profile' @click='load_pixeditor'>
            <input type="file" name="image" accept="image/*" style='display:none' @change='imagize' ref='pixinput'>
            <img class='profilepix' :src='profilepix' v-if='profilepix'>
            <!-- <img class='profilepix' :src='default_character' v-else> -->

            <div class='profilepix-editor'>
              <img class='icon' src='/static/materials/icons/edit.png'>
            </div>
          </div>

          <div class='nick' @click='edit_boo_nick'>
            <span v-if='nick'><b>[[ nick ]]</b></span>
            <span class='tmp' v-else>이름</span>
            <span class='edit'><img src='/static/materials/icons/edit.png'></span>
          </div>

          <div class='text' @click='edit_boo_text'>
            <span v-if='text'>[[ text ]]</span>
            <span class='tmp' v-else>설명을 입력해주세요</span>
            <span class='edit'><img src='/static/materials/icons/edit.png'></span>
          </div>

          <div class='gender labels'>
            <span class='label' v-for='l in genderlabels' :class='select_class(l.id, my_genderlabels)' @click='toggle_select(l.id, my_genderlabels)'>[[ l.label ]]</span>
          </div>

          <div class='age labels'>
            <span class='label' v-for='l in agelabels' :class='select_class(l.id, my_agelabels)' @click='toggle_select_exclusive(l.id, my_agelabels)'>[[ l.label ]]</span>
          </div>


          <div class='labels-shower' v-if='!show_labels' @click='show_labels=true'>
            <span>스타일/관심아이템/체형 입력하기</span><br>
            <img src='/static/materials/icons/backicon.png'>
          </div>

          <div class='style labels' v-if='show_labels'>
            <div class='title'><b>스타일 유형</b></div>
            <hr class='labels_divider'>

            <span class='label' v-for='l in stylelabels' :class='select_class(l.id, my_stylelabels)' @click='toggle_select(l.id, my_stylelabels)'>[[ l.label ]]</span>
            <span class='label more' @click='toggle_more("style")'>[[ more_display("style") ]]</span>

            <template v-if='more_stylelabels'>
              <hr class='labels_divider'>
              <span class='label' v-for='l in stylelabels_more' :class='select_class(l.id, my_stylelabels)' @click='toggle_select(l.id, my_stylelabels)'>[[ l.label ]]</span>
            </template>

            <hr class='labels_divider'>
            <div class='labels-guide'>
              선호하는 스타일을 선택하면 관련 콘텐츠를 노출해 드립니다.
            </div>
          </div>

          <div class='item labels' v-if='show_labels'>
            <div class='title'><b>관심 아이템</b></div>
            <hr class='labels_divider'>

            <span class='label' v-for='l in itemlabels' :class='select_class(l.id, my_itemlabels)' @click='toggle_select(l.id, my_itemlabels)'>[[ l.label ]]</span>
            <span class='label more' @click='toggle_more("item")'>[[ more_display("item") ]]</span>

            <template v-if='more_itemlabels'>
              <hr class='labels_divider'>
              <span class='label' v-for='l in itemlabels_more' :class='select_class(l.id, my_itemlabels)' @click='toggle_select(l.id, my_itemlabels)'>[[ l.label ]]</span>
            </template>

            <hr class='labels_divider'>
            <div class='labels-guide'>
              관심 아이템을 선택하면 관련 콘텐츠를 노출해 드립니다.
            </div>
          </div>

          <div class='body labels' v-if='show_labels'>
            <div class='title'><b>체형 유형</b></div>
            <hr class='labels_divider'>

            <span class='label' v-for='l in bodylabels' :class='select_class(l.id, my_bodylabels)' @click='toggle_select(l.id, my_bodylabels)'>[[ l.label ]]</span>
            <span class='label more' @click='toggle_more("body")'>[[ more_display("body") ]]</span>

            <template v-if='more_bodylabels'>
              <hr class='labels_divider'>
              <span class='label' v-for='l in bodylabels_more' :class='select_class(l.id, my_bodylabels)' @click='toggle_select(l.id, my_bodylabels)'>[[ l.label ]]</span>
            </template>

            <hr class='labels_divider'>
            <div class='labels-guide'>
              체형 정보가 솔직할 수록 패션 조언이 정확해 집니다.
            </div>
          </div>

          <div class='links' v-if='show_labels'>
            <div class='title'><b>SNS</b></div>
            <div class='link' v-for='l in links_all'>
              <!-- <span class='label' :class='link_public_class(l.id)'>[[short_url(l.url)]]</span> -->
              <span class='label' :class='select_class(l.id, boo.links)' @click='toggle_select(l.id, boo.links)'>
                [[short_url(l.url)]]
                <span class='action edit' @click.stop='edit_link(l)'>
                  <img class='icon' src='/static/materials/icons/edit.png'>
                </span>

                <span class='action delete' @click.stop='delete_link(l)' v-if='session.user.auth.boos_fully_loaded'>
                  <img class='icon' src='/static/materials/icons/delete.png'>
                </span>
              </span>
              <!-- <span class='label del'>삭제</span> -->
            </div>

            <div class='link'>
              <span class='label add' @click='add_link'>+추가하기</span>
            </div>
          </div>
        </div>


        <div class='actions' :class='actions_style'>
          <div class='action cancel' @click='session.close_page()' v-if='is_first_profiling'><b>다음에</b></div>
          <div class='action done' :class='action_done_style' @click='action_done'><b>저장</b></div>
        </div>
      </div>
    </template>
  </page2>
</script>


<script>
  Vue.component('profiler', {
    template: '#profiler-template',
    delimiters: ['[[', ']]'],
    props: ['session'],
    data: function() {
      return {
        boo: undefined,
        on_creating: false,
        more_bodylabels: false,
        more_stylelabels: false,
        more_itemlabels: false,
        show_labels: true,
        basket: {},
        // links_new: [],
      }
    },

    created: function() {
      if (this.is_first_profiling) {
        this.show_labels = false;
      }
    },

    watch: {
      'session.page.profiler.open': {
        handler: function(_new, _old) {
          if (_new) {
            if (this.session.page.profiler.type == 'new') {
              console.log('making new profile');

              this.boo = {
                id: undefined,
                nick: '',
                text: '',
                profile: { id: undefined, pix: undefined, pixblob: undefined },
                followees_id: [],
                nfollowers: 0,
                nposts: 0,
                voting_record: {},
                posts: undefined,

                genderlabels: [],
                agelabels: [],
                bodylabels: [],
                stylelabels: [],
                itemlabels: [],
                links: [],

                fit: {},
                ilikes_comment: [],
                active: true
              };

              // this.links_new = [];

              const profilepix = '/static/materials/characters/ghost_' + _.sample(['b', 'm', 'p', 'y']) + '.png';

              fetch(profilepix)
                .then(x => x.blob())
                .then(blob => {
                  this.boo.profile.pix = profilepix;
                  this.boo.profile.pixblob = blob; //URL.createObjectURL(blob);
                  this.reset_basket();
                });


            } else {
              this.boo = _.cloneDeep(this.session.user.auth.boo);

              // 새로운 boo가 복사되면서, 기존 boo서 post loading 하던 것들이 사라진다.
              // 이 부분을 해결하기 위해 아래처럼 기존 boo의 posts를 복사한다
              // 2021.02.09
              this.boo.posts = this.session.user.auth.boo.posts;
              this.reset_basket();
            }
          }
        }, immediate: true
      }
    },

    methods: {
      edit_boo_text: function() {
        this.session.open_texteditor(this.boo.text, '설명을 입력해주세요', 3, txt_done => {
          this.boo.text = txt_done;
          this.reset_basket();
        });
      },

      edit_boo_nick: function() {
        this.session.open_texteditor(this.boo.nick, '이름', 1, txt_done => {
          this.boo.nick = txt_done;
          this.reset_basket();
        });
      },

      add_link: function() {
        this.session.open_texteditor('', 'SNS 주소를 입력해주세요', 1, txt_done => {
          this.on_creating = true;

          const url = (txt_done.indexOf('://') === -1) ? 'https://' + txt_done : txt_done;
          const formdata = new FormData();
          formdata.append('csrfmiddlewaretoken', '{{csrf_token}}');
          formdata.append('url', url);

          fetch('/link/add/', { method: 'POST', body: formdata })
            .then(x => x.json())
            .then(js => {
              console.log(js);

              if (js.success) {
                this.session.user.auth.links.push({ id:js.link_id, url:url });
                this.boo.links.push(js.link_id);
              }

              this.on_creating = false;
              this.reset_basket();
            })
        });
      },

      edit_link: function(link) {
        this.session.open_texteditor(link.url, '', 1, txt_done => {
          this.on_creating = true;

          const url = (txt_done.indexOf('://') === -1) ? 'https://' + txt_done : txt_done;
          const formdata = new FormData();
          formdata.append('csrfmiddlewaretoken', '{{csrf_token}}');
          formdata.append('url', url);
          formdata.append('id', link.id);

          fetch('/link/edit/', { method: 'POST', body: formdata })
            .then(x => x.json())
            .then(js => {
              console.log(js);

              if (js.success) {
                link.url = url;
              }

              this.on_creating = false;
              this.reset_basket();
            })
        });
      },

      delete_link: function(link) {
        const shared_with = {};

        Object.values(this.session.user.auth.boos).forEach(b => {
          if ((b.links.includes(link.id)) && (this.boo.id!=b.id)) {
            // shared_with.push('[' + b.nick + ']');
            shared_with[b.id] = '[' + b.nick + ']';
          }
        });

        // console.log(shared_with);

        this.session.open_bridge('delink_guide', 'top', () => {
          // 우선 다른 부캐에서 링크 지우기
          Object.keys(shared_with).forEach(i => {
            const _boo_links = this.session.user.auth.boos[i].links;
            const where = _boo_links.indexOf(link.id);
            _boo_links.splice(where, 1);
          });

          // 현재부캐의 원본에 해당 링크가 있다면, 지우기
          if (this.session.user.auth.boo.links.includes(link.id)) {
            const where = this.session.user.auth.boo.links.indexOf(link.id);
            this.session.user.auth.boo.links.splice(where, 1);
          }

          // 현재부캐의 사본에 해당 링크가 있다면, 지우기
          if (this.boo.links.includes(link.id)) {
            const where = this.boo.links.indexOf(link.id);
            this.boo.links.splice(where, 1);
          }

          // session.user.auth의 link 리스트에서 지우기
          this.session.user.auth.links = _.reject(this.session.user.auth.links, ['id', link.id]);

          fetch('/link/delete/' + link.id)
            .then(x => x.json())
            .then(js => { console.log(js); });

        }, Object.values(shared_with).join(', '));
      },

      labels_to_update: function(what) {
        const labels = {};
        let add, remove;

        if (this.making_new) {
          add = this.boo[what];
          remove = []

        } else {
          add = _.difference(this.boo[what], this.session.user.auth.boo[what]);
          remove = _.difference(this.session.user.auth.boo[what], this.boo[what]);
        }

        // 빈 배열인지 확인해야한다
        if (add.length > 0) {
          labels.add = add;
        }

        if (remove.length > 0) {
          labels.remove = remove;
        }

        return labels
      },

      _is_not_empty_obj: function(obj) {
        return Object.keys(obj).length > 0
      },

      reset_basket: function() {
        this.basket = {};

        const labels = {};
        const genderlabels = this.labels_to_update('genderlabels');
        const agelabels = this.labels_to_update('agelabels');
        const bodylabels = this.labels_to_update('bodylabels');
        const stylelabels = this.labels_to_update('stylelabels');
        const itemlabels = this.labels_to_update('itemlabels');
        const links = this.labels_to_update('links');

        if (this._is_not_empty_obj(genderlabels)) {
          labels.genderlabels = genderlabels;
        }

        if (this._is_not_empty_obj(agelabels)) {
          labels.agelabels = agelabels;
        }

        if (this._is_not_empty_obj(bodylabels)) {
          labels.bodylabels = bodylabels;
        }

        if (this._is_not_empty_obj(stylelabels)) {
          labels.stylelabels = stylelabels;
        }

        if (this._is_not_empty_obj(itemlabels)) {
          labels.itemlabels = itemlabels;
        }

        if (this._is_not_empty_obj(links)) {
          labels.links = links;
          // this.basket.links = links;
        }

        if (this._is_not_empty_obj(labels)) {
          this.basket.labels = labels;
        }


        // if (this.links_new.length > 0) {
        //   this.basket.links_new = this.links_new;
        // }

        if ((this.making_new && this.boo.nick!='') || (!this.making_new && this.boo.nick!=this.session.user.auth.boo.nick)) {
          this.basket.boo_nick = this.boo.nick;
        }

        if ((this.making_new && this.boo.text!='') || (!this.making_new && this.boo.text!=this.session.user.auth.boo.text)) {
          this.basket.boo_text = this.boo.text;
        }

        if ((this.making_new && this.boo.profile.pix) || (!this.making_new && this.boo.profile.pix!=this.session.user.auth.boo.profile.pix)) {
          this.basket.profilepix = this.boo.profile.pixblob;
        }
      },

      action_done: function() {
        if (this.on_creating || !this.ready_to_save) {
          return
        }

        const formdata = new FormData();
        formdata.append('csrfmiddlewaretoken', '{{csrf_token}}');

        if (this.basket.boo_nick) {
          formdata.append('boo_nick', this.basket.boo_nick);
        }

        if (this.basket.boo_text) {
          formdata.append('boo_text', this.basket.boo_text);
        }

        if (this.basket.profilepix) {
          const pixname = new Date().getTime() + '__profilepix.png';
          formdata.append('profilepix', this.basket.profilepix, pixname);
        }

        if (this.basket.labels) {
          formdata.append('labels', JSON.stringify(this.basket.labels));
        }

        if (this.making_new) {
          this.boo_create(formdata);

        } else {
          this.boo_update(formdata);
        }

        this.session.user.auth.first_visit = false;
      },

      boo_create: function(formdata) {
        this.on_creating = true;
        formdata.append('on_creating', true);

        fetch('/boo/save/', { method: 'POST', body: formdata })
          .then(res => res.json())
          .then(js => {
            console.log(js);
            this.on_creating = false;
            this.boo.id = js.boo_id;
            this.$set(this.session.user.auth.boos, this.boo.id, this.boo);
            this.session.user.auth.boo = this.boo.id;
            // this.$set(this.session._auth.boos, this.boo.id, this.boo);
            // this.session._auth.boo = this.boo.id;
            this.session.close_page();
          });
      },

      boo_update: function(formdata) {
        const boo_id = this.boo.id;
        this.boo.id = undefined;

        fetch('/boo/save/', { method: 'POST', body: formdata })
          .then(res => res.json())
          .then(js => {
            console.log(js);
            this.boo.id = boo_id;
          });

        this.session.user.auth.boos[boo_id] = this.boo;
        // this.session._auth.boos[boo_id] = this.boo;
        // this.$set(this.session._auth.boos, this.boo.id, this.boo);
        this.session.close_page();
      },

      select_class: function(key, my) {
        if (my.includes(Number(key))) {
          return 'selected'

        } else {
          return ''
        }
      },

      toggle_select: function(key, my) {
        const k = Number(key);

        if (my.includes(k)) {
          const idx = my.indexOf(k);

          if (idx !== -1) {
            my.splice(idx, 1);
          }

        } else {
          my.push(k);
        }

        this.reset_basket();
      },

      toggle_select_exclusive: function(key, my) {
        const k = Number(key);

        if (my.includes(k)) {
          const idx = my.indexOf(k);

          if (idx !== -1) {
            my.splice(idx, 1);
          }

        } else {
          my.length = 0;
          my.push(k);
        }

        this.reset_basket();
      },

      toggle_more: function(what) {
        const target = 'more_' + what + 'labels';
        this[target] = !this[target];
        // what = !what;
      },

      // link_public_class: function(link_id) {
      //   return {
      //     public: _.findIndex(this.boo.links, {'id':link_id, 'public':true}) > -1
      //   }
      // },

      more_display: function(what) {
        const target = 'more_' + what + 'labels';
        return this[target] ? "덜보기" : "더보기"
      },

      load_pixeditor: function() {
        if (this.$refs) {
          this.$refs.pixinput.click();
        }
      },

      imagize: function(event) {
        const input = event.target;
        const self = this;

        if (input.files && input.files[0]) {
          let reader = new FileReader();
          reader.onload = function(e) {
            self.session.open_pixeditor(e.target.result, 'profile', self);
          };

          reader.readAsDataURL(input.files[0]);
        }
      },

      set: function(blob) {
        this.boo.profile.pix = URL.createObjectURL(blob);
        this.boo.profile.pixblob = blob;
        this.reset_basket();
      },


      delboo: function() {
        this.session.open_bridge('delboo_guide', 'top', () => {
          const boos = this.session.user.auth.boos;
          const cboo_id = this.session.user.auth.boo_selected;

          fetch('/boo/profile/delete/')
            .then(x => x.json())
            .then(j => { console.log(j) });

          const _boo_id = Object.keys(boos)
            .filter(x => x !== String(cboo_id) )
            .sort((a,b) => Number(b) - Number(a) )[0];

          this.session.user.auth.boo = Number(_boo_id);
          this.session.close_page();
          this.$delete(boos, cboo_id);
        });
      },

      short_url: function(url) {
        return url.replace(/^(?:https?:\/\/)?(?:www\.)?/i, '')
      },
    },


    computed: {
      ready_to_save: function() {
        if (Object.keys(this.basket).length > 0) {
          if (this.making_new) {
            // 새로 만들때는: 이름과 프로필사진이 반드시 있어야하고
            if (!this.basket.boo_nick || !this.basket.profilepix)
              return false

          } else {
            // 새로 만드는게 아니라면: 이름과 프로필사진이 공란이면 안된다
            if (('boo_nick' in this.basket) && this.basket.boo_nick=='')
              return false

            if (('profilepix' in this.basket) && this.basket.profilepix==undefined)
              return false
          }

          return true
        }
      },

      actions_style: function() {
        return { cancelable: this.is_first_profiling }
      },

      action_done_style: function() {
        return { active: !this.on_creating && this.ready_to_save }
      },

      profilepix: function() {
        return this.boo.profile.pix
      },

      text: function() {
        return this.boo.text
      },

      nick: function() {
        return this.boo.nick
      },

      is_first_profiling: function() {
        return this.session.user.auth.first_visit
        // return this.session.user.auth ? false : true
      },

      my_genderlabels: function() {
        return this.boo.genderlabels
      },

      my_agelabels: function() {
        return this.boo.agelabels
      },

      my_bodylabels: function() {
        return this.boo.bodylabels
      },

      my_stylelabels: function() {
        return this.boo.stylelabels
      },

      my_itemlabels: function() {
        return this.boo.itemlabels
      },

      genderlabels: function() {
        return this.session.labels.gender
      },

      agelabels: function() {
        return this.session.labels.age
      },

      bodylabels: function() {
        return this.session.labels.body.slice(0, 4)
      },

      bodylabels_more: function() {
        return this.session.labels.body.slice(4)
      },

      stylelabels: function() {
        return this.session.labels.style.slice(0, 4)
      },

      stylelabels_more: function() {
        return this.session.labels.style.slice(4)
      },

      itemlabels: function() {
        return this.session.labels.item.slice(0, 4)
      },

      itemlabels_more: function() {
        return this.session.labels.item.slice(4)
      },

      making_new: function() {
        return this.session.page.profiler.type == 'new'
      },

      loader_width: function() {
        return document.querySelector('#window').clientWidth
      },

      deletable: function() {
        return (this.session.page.profiler.type!="new") && (Object.keys(this.session.user.auth.boos).length>1)
        // return (this.session.page.profiler.type!="new") && (Object.keys(this.session._auth.boos).length>1)
      },

      links_all: function() {
        return this.session.user.auth.links
        // const _links = _.flatten(Object.values(this.session.user.auth.boos).map(b => b.links));
        // return _.uniqBy(_links, 'id').map(l => _.pick(l, ['id', 'url']))
      }
    }
  });
</script>
