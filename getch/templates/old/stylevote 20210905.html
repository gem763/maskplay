<style>
  .stylevote.vcomp .page-body > .analyzer {
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
  }

  .stylevote.vcomp .page-body > .analyzer.on {
    opacity: 1;
    pointer-events: auto;
  }

  .stylevote.vcomp .page-body > .analyzer > .box {
    position: absolute;
    left: 16px;
    right: 16px;
    top: 100%;
    height: calc(50% - 77px - 16px - var(--iphone-bottom));
    background: white;
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s;
    /* display: flex;
    flex-direction: column; */
  }

  .stylevote.vcomp .page-body > .analyzer.on > .box {
    top: 50%;
  }

  .stylevote.vcomp .page-body > .analyzer > .box > .head {
    position: relative;
    width: 100%;
    height: 50px;
    background: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    font-weight: bold;
    color: var(--color-dark);
  }

  .stylevote.vcomp .page-body > .analyzer > .box > .content {
    position: relative;
    padding: 0 16px 16px 16px;
    box-sizing: border-box;
    /* flex-grow: 1; */
    background: white;
    overflow-y: auto;
    height: calc(100% - 50px - 16px);
  }

  .stylevote.vcomp .page-body > .analyzer > .box > .content > .item {
    position: relative;
    width: 100%;
    padding-top: 20px;
    font-size: 14px;
  }

  .stylevote.vcomp .page-body > .analyzer > .box > .content > .item > .pbar {
    position: relative;
    width: 100%;
    height: 5px;
    background: white;
    border-radius: 100px;
    box-shadow: 0 0 0 0.3px #888888 inset;
    box-sizing: border-box;
    margin-top: 5px;
  }

  .stylevote.vcomp .page-body > .analyzer > .box > .content > .item > .pbar > .core {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 50%;
    background: #404277;
    border-radius: 100px;
  }

  .stylevote.vcomp .page-body > .swiper-container {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    background: white;
  }

  .stylevote.vcomp .page-body > .swiper-container > .swiper-wrapper {
    /* z-index: 0; */
  }

  .stylevote.vcomp .page-body > .swiper-container > .swiper-wrapper > .swiper-slide {
    position: relative;
    width: 100%;
    height: 100%;
    background: white;
  }


  .stylevote.vcomp .page-body > .loginplz {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .stylevote.vcomp .page-body > .loginplz > .logger {
    width: 260px;
    height: 120px;
    background: white;
    border-radius: var(--w-3);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    overflow: hidden;
  }

  .stylevote.vcomp .page-body > .loginplz > .logger > .title {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-grow: 1;
    width: 100%;
    font-size: 16px;
    font-weight: bold;
  }

  .stylevote.vcomp .page-body > .loginplz > .logger > .actions {
    position: relative;
    width: 100%;
    height: calc(33px + 20px);
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  .stylevote.vcomp .page-body > .loginplz > .logger > .actions > .action {
    width: 50%;
    height: calc(100% - 20px);
    background: var(--color-point);
    border-radius: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 15px;
  }
</style>


<script type='text/x-template' id='stylevote-template'>
  <page
    class='stylevote vcomp'
    :order='session.page.stylevote.order'
    :open='session.page.stylevote.open'
    :from='session.page.stylevote.from'
    :hide_close='true'
    :hide_menu='true'
    :hide_headerbar='true'
    :trans_headerbar='true'>

    <template #headerbar-menu>
    </template>

    <template #headerbar-body-default>
    </template>

    <template #page-body>
      <div class='swiper-container' ref='swiper'>
        <div class='swiper-wrapper'>
          <div class="swiper-slide" v-for='pp in pixpair_set.list'>
            <pixchooser :pixpair='pp' :swiper='swiper' :session='session'></pixchooser>
          </div>
        </div>
      </div>

      <div class='analyzer' :class='{ on: on_analyzer }' @click='close_analyzer'>
        <div class='box' @click.stop>
          <div class='head'>내가 선호하는 스타일은?</div>

          <div class='content'>
            <!-- <div class='item' v-for='r in result_ordered'>
              <span>[[ r[0] ]]</span>
              <div class='pbar'>
                <div class='core' :style='pbar_style(r[1])'></div>
              </div>
            </div> -->

          </div>
        </div>
      </div>
    </template>
  </page>
</script>


<script>
  Vue.component('stylevote', {
    template: '#stylevote-template',
    delimiters: ['[[', ']]'],
    props: ['session'],
    data: function() {
      return {
        on_analyzer: false,
        // on_loginplz: false,
        swiper: undefined,
        swiper_options: {
          direction: 'horizontal',
          simulateTouch: true,
          observer: true,
          observeParents: true,
          slidesPerView: 'auto',
          mousewheel: {
            releaseOnEdges: true,
          }
        },

        // result: {
        //   '검정': 8,
        //   '스니커즈': 19,
        //   '모자': 17,
        //   '바지': 16,
        //   '블레이저': 12,
        // }
      }
    },

    watch: {
      ipixpair: function(_new, _old) {
        if (this.pixpair_set.list.length - _new <= 3) {
          this.pixpair_set.load(3);
        }

        if (_new > _old) {
          this.session.scroll_direction = 'down';
        } else {
          this.session.scroll_direction = 'up';
        }
      },

      stat_updated: function(_new, _old) {
        if (_new) {
          this.on_analyzer = true;
          setTimeout(() => { this.session.balancegame.stat_updated = false; }, 100);
        }
      }
    },


    mounted: function() {
      this.swiper = new Swiper(this.$refs.swiper, this.swiper_options);
    },

    methods: {
      goto_first: function() {
        this.swiper.slideNext();
      },

      // show_loginplz: function() {
      //   this.on_loginplz = true;
      // },
      //
      // dismiss_loginplz: function() {
      //   this.on_loginplz = false;
      // },

      goto_login: function() {
        this.session.open_login();
        // this.on_loginplz = false;
      },

      pbar_style: function(val) {
        if (this.result) {
          return {
            width: (val - this.result_min) / (this.result_max - this.result_min) * 100 + '%'
          }
        }
      },

      close_analyzer: function() {
        this.on_analyzer = false;
      }
    },

    computed: {
      pixpair_set: function() {
        return this.session.balancegame.pixpair_set
        // return this.session.page.stylevote.contents
      },

      ipixpair: function() {
        if (this.swiper) {
          return this.swiper.realIndex
        }
      },

      result: function() {
        return this.session.balancegame.stat
      },

      result_values: function() {
        if (this.result) {
          return Object.values(this.result)
        }
      },

      result_max: function() {
        if (this.result_values) {
          return Math.max(...this.result_values)
        }
      },

      result_min: function() {
        if (this.result_values) {
          return Math.min(...this.result_values) * 0.7
        }
      },

      result_ordered: function() {
        if (this.result) {
          return Object.entries(this.result).sort((a,b) => b[1]-a[1])
        }
      },

      stat_updated: function() {
        return this.session.balancegame.stat_updated
      }
    }
  });
</script>
